---
- name: Monitor and restart Docker services if needed
  hosts: riot_vms
  gather_facts: false
  vars_files:
    - group_vars/all.yml

  tasks:
    - name: Run the check script
      ansible.builtin.shell: "{{ check_scripts[inventory_hostname] }}"
      register: check_result
      ignore_errors: true
      changed_when: false

    - name: Debug check result
      ansible.builtin.debug:
        msg: "Check script returned {{ check_result.rc }}"

    - name: Restart service if check failed (rc 1 or 2)
      ansible.builtin.shell: "{{ restart_scripts[inventory_hostname] }}"
      when: check_result.rc in [1, 2]
      register: restart_result
      ignore_errors: true
      changed_when: restart_result.rc == 0

    - name: Wait for 30 seconds after restart
      ansible.builtin.pause:
        seconds: 30
      when: check_result.rc in [1, 2]

    - name: Re-run the check script after restart
      ansible.builtin.shell: "{{ check_scripts[inventory_hostname] }}"
      register: recheck_result
      when: check_result.rc in [1, 2]
      ignore_errors: true
      changed_when: false

    - name: Report final status
      ansible.builtin.debug:
        msg: >
          "Initial check: {{ check_result.rc }},
          After restart: {{ recheck_result.rc | default('N/A') }}"
